<!-- partials/nav.html -->
<nav class="bg-black p-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap">
      <div class="block lg:hidden ml-auto">
        <button id="nav-toggle" class="flex items-center px-3 py-2 border rounded text-gray-300 border-gray-400 hover:text-white hover:border-white">
          <svg class="fill-current h-4 w-4" viewBox="0 0 20 20">
            <path d="M0 3h20v2H0zM0 9h20v2H0zM0 15h20v2H0z"/>
          </svg>
        </button>
      </div>

      <!-- Mobile Menu -->
      <div id="nav-menu-mobile" class="w-full block lg:hidden hidden transition-all duration-300 ease-in-out">
        <div class="flex flex-col space-y-2 mt-4">
          <a href="/" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-center">Home</a>
          <a href="/events" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-center">Events</a>
          <a href="/accolades" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-center">Accolades</a>
          <a href="/admin" data-link id="admin-link-mobile" class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded text-center hidden">Admin</a>
          <button id="login-btn-mobile" class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded hidden">Login with Discord</button>
          <button id="logout-btn-mobile" class="bg-gray-800 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded hidden">Logout</button>
        </div>
      </div>

      <!-- Desktop Menu -->
      <div class="hidden lg:flex lg:items-center lg:w-auto lg:ml-auto space-x-4">
        <p id="user-info" class="text-gray-300 hidden mt-2">Logged in as <span id="display-name"></span></p>
        <a href="/" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded">Home</a>
        <a href="/events" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded">Events</a>
        <a href="/accolades" data-link class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded">Accolades</a>
        <a href="/admin" data-link id="admin-link" class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded hidden">Admin</a>
        <button id="login-btn" class="bg-pfc-red hover:bg-red-800 text-white font-bold py-2 px-4 rounded hidden">Login with Discord</button>
        <button id="logout-btn" class="bg-gray-800 hover:bg-gray-800 text-white font-bold py-2 px-6 rounded hidden">Logout</button>
      </div>
    </div>
  </nav>
  
<script>
    console.log('[nav] Script start');
  
    document.getElementById('nav-toggle')?.addEventListener('click', () => {
      const menu = document.getElementById('nav-menu-mobile');
      if (!menu) return;
      menu.classList.toggle('hidden');
      menu.style.maxHeight = menu.classList.contains('hidden') ? null : menu.scrollHeight + 'px';
    });
  
    const show = id => {
      const el = document.getElementById(id);
      if (el) {
        console.log(`[nav] Showing ${id}`);
        el.classList.remove('hidden');
      }
    };
  
    const hide = id => {
      const el = document.getElementById(id);
      if (el) {
        console.log(`[nav] Hiding ${id}`);
        el.classList.add('hidden');
        if (id === 'user-info') el.classList.remove('lg:inline-block');
      }
    };
  
    async function waitForNavElements(timeout = 1000) {
      const required = ['login-btn', 'logout-btn', 'user-info', 'display-name'];
      const start = Date.now();
      while (Date.now() - start < timeout) {
        const missing = required.filter(id => !document.getElementById(id));
        if (missing.length === 0) return true;
        await new Promise(r => setTimeout(r, 50));
      }
      console.warn('[nav] Timeout waiting for nav elements');
      return false;
    }
  
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[nav] DOMContentLoaded');
      const token = localStorage.getItem('jwt');
      console.log('[nav] Token:', token);
  
      const page = window.location.pathname;
      await waitForNavElements();
  
      let user = null;
      if (token) {
        try {
          user = await PFCDiscord.getUser();
          console.log('[nav] User:', user);
        } catch (err) {
          console.warn('[nav] Failed to get user:', err);
        }
      }
  
      const isAdmin = user && Array.isArray(user.roles) && user.roles.includes('Server Admin');
      console.log('[nav] Is admin:', isAdmin);
  
      if (user) {
        document.getElementById('display-name').textContent = user.displayName;
  
        show('user-info');
        show('logout-btn'); show('logout-btn-mobile');
        hide('login-btn'); hide('login-btn-mobile');
  
        if (isAdmin) {
          show('admin-link'); show('admin-link-mobile');
          show('admin-container');
        } else {
          hide('admin-link'); hide('admin-link-mobile');
          hide('admin-container');
          if (page.includes('admin.html')) {
            console.log('[nav] Redirecting non-admin');
            window.location.href = '../unauthorized.html';
          }
        }
      } else {
        show('login-btn'); show('login-btn-mobile');
        hide('logout-btn'); hide('logout-btn-mobile');
        hide('user-info');
        hide('admin-link'); hide('admin-link-mobile');
        hide('admin-container');
        if (page.includes('admin.html')) {
          console.log('[nav] Redirecting unauthenticated user');
          window.location.href = '../unauthorized.html';
        }
      }
  
      console.log('[nav] Logic complete');
    });
  </script>
  